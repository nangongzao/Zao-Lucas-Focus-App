<!-- 略去<head>部分不变 -->

<script>
  let musicPlayer = document.getElementById('music-player');
  let noisePlayer = document.getElementById('noise-player');
  let loopControl = document.getElementById('loop-control');
  let songSelect = document.getElementById('song-select');
  let noiseLoopControl = document.getElementById('noise-loop-control');
  let noiseSongSelect = document.getElementById('noise-song-select');
  let addMusicPopup = document.getElementById('add-music-popup');
  let fileInput = document.getElementById('file-input');
  let songListContainer = document.getElementById('song-list');
  let currentPlayerType = 'music';

  window.onload = function () {
    loadSongs('music');
    loadSongs('noise');

    musicPlayer.volume = 0.4;
    noisePlayer.volume = 0.6;

    loopControl.value = 'loop';
    noiseLoopControl.value = 'repeat';

    autoPlayFirstSong('music');
    autoPlayFirstSong('noise');

    // 监听播放结束
    musicPlayer.addEventListener('ended', function () {
      handleLoop('music');
    });

    noisePlayer.addEventListener('ended', function () {
      handleLoop('noise');
    });
  }

  function handleLoop(playerType) {
    const control = playerType === 'music' ? loopControl : noiseLoopControl;
    const player = playerType === 'music' ? musicPlayer : noisePlayer;
    const select = playerType === 'music' ? songSelect : noiseSongSelect;
    const songs = JSON.parse(localStorage.getItem(playerType + 'Songs') || '[]');
    let index = parseInt(select.value);

    if (control.value === 'repeat') {
      player.currentTime = 0;
      player.play();
    } else if (control.value === 'loop') {
      index = (index + 1) % songs.length;
      select.value = index;
      const source = player.querySelector('source');
      source.src = songs[index].src;
      player.load();
      player.play();
    }
  }

  function autoPlayFirstSong(playerType) {
    const savedSongs = localStorage.getItem(playerType + 'Songs');
    if (savedSongs) {
      const songs = JSON.parse(savedSongs);
      if (songs.length > 0) {
        const player = playerType === 'music' ? musicPlayer : noisePlayer;
        const source = player.querySelector('source');
        source.src = songs[0].src;
        player.load();
        player.play();

        const selectElement = playerType === 'music' ? songSelect : noiseSongSelect;
        selectElement.value = 0;
      }
    }
  }

  function loadSongs(playerType) {
    const savedSongs = localStorage.getItem(playerType + 'Songs');
    const selectElement = playerType === 'music' ? songSelect : noiseSongSelect;
    const songList = songListContainer;
    if (savedSongs) {
      const songs = JSON.parse(savedSongs);
      selectElement.innerHTML = '<option value="">请选择歌曲</option>';
      if (playerType === 'music') songList.innerHTML = '';

      songs.forEach((song, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = song.name;
        selectElement.appendChild(option);

        if (playerType === 'music') {
          const songItem = document.createElement('div');
          songItem.classList.add('song-item');
          songItem.innerHTML = `${song.name} <button onclick="deleteSong(${index}, '${playerType}')">删除</button>`;
          songList.appendChild(songItem);
        }
      });

      selectElement.onchange = function () {
        const index = parseInt(this.value);
        if (!isNaN(index)) {
          const player = playerType === 'music' ? musicPlayer : noisePlayer;
          const source = player.querySelector('source');
          source.src = songs[index].src;
          player.load();
          player.play();
        }
      };
    }
  }

  function deleteSong(index, playerType) {
    const savedSongs = localStorage.getItem(playerType + 'Songs');
    if (savedSongs) {
      let songs = JSON.parse(savedSongs);
      songs.splice(index, 1);
      localStorage.setItem(playerType + 'Songs', JSON.stringify(songs));
      loadSongs(playerType);
    }
  }

  function openAddMusicPopup(playerType) {
    currentPlayerType = playerType;
    addMusicPopup.classList.add('show');
  }

  function closeAddMusicPopup() {
    addMusicPopup.classList.remove('show');
  }

  function addMusic() {
    const file = fileInput.files[0];
    if (file) {
      const name = file.name;
      const src = URL.createObjectURL(file);
      const song = { name, src };
      const savedSongs = localStorage.getItem(currentPlayerType + 'Songs');
      const songs = savedSongs ? JSON.parse(savedSongs) : [];
      songs.push(song);
      localStorage.setItem(currentPlayerType + 'Songs', JSON.stringify(songs));
      loadSongs(currentPlayerType);
      closeAddMusicPopup();
    }
  }

  loopControl.onchange = function () {
    // 改变播放行为在播放器 ended 事件中处理
  }

  noiseLoopControl.onchange = function () {
    // 同上
  }
</script>
