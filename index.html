function closeAddMusicPopup() {
  addMusicPopup.classList.remove('show');
}

function loadSongs(type) {
  const selectElement = type === 'music' ? songSelect : noiseSongSelect;
  selectElement.innerHTML = '<option value="">请选择歌曲</option>';

  const savedSongs = localStorage.getItem(type + 'Songs');
  if (savedSongs) {
    const songs = JSON.parse(savedSongs);
    songs.forEach((song, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = song.name;
      selectElement.appendChild(option);
    });
  }
}

function addMusic() {
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const savedSongs = localStorage.getItem(currentPlayerType + 'Songs');
    let songs = savedSongs ? JSON.parse(savedSongs) : [];

    const newSong = {
      name: file.name,
      src: e.target.result
    };

    songs.push(newSong);
    localStorage.setItem(currentPlayerType + 'Songs', JSON.stringify(songs));

    loadSongs(currentPlayerType);
    loadSongList(currentPlayerType);
    fileInput.value = '';
  };

  reader.readAsDataURL(file);
}

function deleteSong(index) {
  let songs = JSON.parse(localStorage.getItem(currentPlayerType + 'Songs'));
  songs.splice(index, 1);
  localStorage.setItem(currentPlayerType + 'Songs', JSON.stringify(songs));
  loadSongs(currentPlayerType);
  loadSongList(currentPlayerType);
}

function loadSongList(type) {
  let songs = JSON.parse(localStorage.getItem(type + 'Songs') || '[]');
  songListContainer.innerHTML = '<h3>已添加的歌曲：</h3>';
  songs.forEach((song, index) => {
    let div = document.createElement('div');
    div.className = 'song-item';
    div.innerHTML = `<span>${song.name}</span><button onclick="deleteSong(${index})">删除</button>`;
    songListContainer.appendChild(div);
  });
}

songSelect.addEventListener('change', function () {
  let songs = JSON.parse(localStorage.getItem('musicSongs'));
  let selected = this.value;
  if (songs[selected]) {
    musicPlayer.src = songs[selected].src;
    musicPlayer.play();
  }
});

noiseSongSelect.addEventListener('change', function () {
  let songs = JSON.parse(localStorage.getItem('noiseSongs'));
  let selected = this.value;
  if (songs[selected]) {
    noisePlayer.src = songs[selected].src;
    noisePlayer.play();
  }
});

loopControl.addEventListener('change', function () {
  musicPlayer.loop = this.value !== 'none';
});

noiseLoopControl.addEventListener('change', function () {
  noisePlayer.loop = this.value !== 'none';
});
